# ==================================
# Preview Deployment Workflow
# ==================================
# Creates preview deployments for pull requests
# Posts deployment URL as PR comment
# ==================================

name: Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

# Cancel previous runs for the same PR
concurrency:
  group: preview-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Deploy preview
  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    outputs:
      preview-url: ${{ steps.deploy.outputs.preview-url }}
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Deploy to Vercel Preview
        id: deploy
        uses: amondnet/vercel-action@v25
        continue-on-error: true
        if: ${{ secrets.VERCEL_TOKEN != '' }}
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          vercel-args: ''
          working-directory: ./

      - name: Notify if secrets missing
        if: ${{ secrets.VERCEL_TOKEN == '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = `### ‚ö†Ô∏è Vercel Deployment Yapƒ±landƒ±rmasƒ± Gerekli

            Preview deployment olu≈üturulamadƒ± √ß√ºnk√º Vercel secret'larƒ± tanƒ±mlanmamƒ±≈ü.

            #### Gerekli Ayarlar

            A≈üaƒüƒ±daki secret'larƒ± repository ayarlarƒ±na eklemelisiniz:

            1. **VERCEL_TOKEN** - Vercel API token'ƒ±nƒ±z
            2. **VERCEL_ORG_ID** - Vercel organizasyon ID'niz  
            3. **VERCEL_PROJECT_ID** - Vercel proje ID'niz

            #### Nasƒ±l Yapƒ±lƒ±r?

            1. [Vercel token olu≈üturun](https://vercel.com/account/tokens)
            2. [Repository secrets sayfasƒ±na](https://github.com/${{ github.repository }}/settings/secrets/actions) gidin
            3. Yukarƒ±daki secret'larƒ± ekleyin
            4. Workflow'u tekrar √ßalƒ±≈ütƒ±rƒ±n

            ---
            <sub>Bu mesaj otomatik olarak olu≈üturulmu≈ütur.</sub>`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Comment PR with preview URL
        if: ${{ steps.deploy.outcome == 'success' && steps.deploy.outputs.preview-url != '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const previewUrl = '${{ steps.deploy.outputs.preview-url }}';
            const comment = `### üöÄ Preview Deployment Ready

            Your preview deployment is ready for review!

            **Preview URL:** ${previewUrl}

            ---

            #### Build Information
            - **Commit:** \`${{ github.sha }}\`
            - **Branch:** \`${{ github.head_ref }}\`
            - **Deployed at:** ${new Date().toUTCString()}

            #### Quick Links
            - [View Deployment](${previewUrl})
            - [View Build Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ---
            <sub>This preview will be automatically deleted when the PR is closed.</sub>`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview Deployment Ready')
            );

            // Update or create comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Add deployment status check
        if: ${{ steps.deploy.outcome == 'success' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: 'success',
              target_url: '${{ steps.deploy.outputs.preview-url }}',
              description: 'Preview deployment ready',
              context: 'Vercel Preview'
            });

  # Lighthouse CI (optional)
  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    needs: deploy-preview
    if: ${{ needs.deploy-preview.outputs.preview-url != '' }}
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        continue-on-error: true
        with:
          urls: |
            ${{ needs.deploy-preview.outputs.preview-url }}
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Comment Lighthouse scores
        uses: actions/github-script@v7
        if: always()
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = `### üìä Lighthouse Report

            Lighthouse audit has been completed for your preview deployment.

            Check the [full report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed metrics.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
