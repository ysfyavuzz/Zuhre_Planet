version: '3.8'

services:
  # Main Zuhre Planet Services
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: zuhre_api
    restart: always
    environment:
      NODE_ENV: production
      DATABASE_URL: postgres://zuhre_user:your_strong_db_password@db:5432/zuhre_db
      JWT_SECRET: ${JWT_SECRET:-dev-secret-key}
      PORT: 3000
      VITE_API_URL: http://localhost:3000/api
      VITE_WS_URL: ws://localhost:3000
      # Image generation
      SDXL_API: http://sdxl:7860/api
    ports:
      - "3000:3000"
    depends_on:
      - db
      - sdxl
    networks:
      - zuhre_network
    volumes:
      - ./uploads:/app/uploads

  db:
    image: postgres:15-alpine
    container_name: zuhre_db
    restart: always
    environment:
      POSTGRES_USER: zuhre_user
      POSTGRES_PASSWORD: your_strong_db_password
      POSTGRES_DB: zuhre_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - zuhre_network

  nginx:
    image: nginx:alpine
    container_name: zuhre_nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./dist:/usr/share/nginx/html:ro
      - ./uploads:/usr/share/nginx/html/uploads:ro
    depends_on:
      - api
    networks:
      - zuhre_network

  # Stable Diffusion XL - Image Generation
  sdxl:
    image: ghcr.io/openwebui/open-webui:latest
    container_name: zuhre_sdxl
    restart: always
    ports:
      - "7860:8080"
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
      - WEBUI_SECRET_KEY=change-me-in-production
      - ALLOW_CORS=true
    volumes:
      - ./sdxl-models:/root/.cache/huggingface
      - ./sdxl-outputs:/app/outputs
      - ./sdxl-data:/app/backend/data
    networks:
      - zuhre_network

  # Optional: Ollama for text generation
  ollama:
    image: ollama/ollama:latest
    container_name: zuhre_ollama
    restart: always
    ports:
      - "11434:11434"
    environment:
      - OLLAMA_HOST=0.0.0.0:11434
    volumes:
      - ./ollama-models:/root/.ollama
    networks:
      - zuhre_network

volumes:
  postgres_data:
    driver: local

networks:
  zuhre_network:
    driver: bridge
