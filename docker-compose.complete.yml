version: '3.8'

services:
  # Main Zuhre Planet Services
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: zuhre_api
    restart: always
    environment:
      NODE_ENV: production
      DATABASE_URL: postgres://zuhre_user:your_strong_db_password@db:5432/zuhre_db
      JWT_SECRET: ${JWT_SECRET:-dev-secret-key}
      PORT: 3000
      VITE_API_URL: http://localhost:3000/api
      VITE_WS_URL: ws://localhost:3000
      OLLAMA_API: http://ollama:11434/api
      SDXL_API: http://sdxl:7860/api
    ports:
      - "3000:3000"
    depends_on:
      - db
      - ollama
      - sdxl
    networks:
      - zuhre_network
    volumes:
      - ./uploads:/app/uploads

  db:
    image: postgres:15-alpine
    container_name: zuhre_db
    restart: always
    environment:
      POSTGRES_USER: zuhre_user
      POSTGRES_PASSWORD: your_strong_db_password
      POSTGRES_DB: zuhre_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - zuhre_network

  nginx:
    image: nginx:alpine
    container_name: zuhre_nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./dist:/usr/share/nginx/html:ro
    depends_on:
      - api
    networks:
      - zuhre_network

  # Ollama - Text Generation (Local LLM)
  ollama:
    image: ollama/ollama:latest
    container_name: zuhre_ollama
    restart: always
    ports:
      - "11434:11434"
    environment:
      - OLLAMA_HOST=0.0.0.0:11434
    volumes:
      - ./ollama-models:/root/.ollama
    networks:
      - zuhre_network

  # SDXL - Image Generation
  sdxl:
    image: python:3.11-slim
    container_name: zuhre_sdxl
    restart: always
    ports:
      - "7860:7860"
    working_dir: /app
    command: >
      bash -c "
        pip install -q gradio pillow torch torchvision &&
        git clone https://github.com/AUTOMATIC1111/stable-diffusion-webui.git /sdxl 2>/dev/null || true &&
        cd /sdxl &&
        python webui.py --listen 0.0.0.0 --port 7860 --opt-sub-quad-attention --no-half 2>/dev/null || echo 'SDXL startup...'
      "
    volumes:
      - ./sdxl-models:/root/.cache/huggingface
      - ./sdxl-outputs:/outputs
    networks:
      - zuhre_network
    environment:
      - GRADIO_SERVER_NAME=0.0.0.0
      - GRADIO_SERVER_PORT=7860

volumes:
  postgres_data:
    driver: local

networks:
  zuhre_network:
    driver: bridge
